#!/usr/bin/env bash

BACKGROUND_IMAGE="$HOME/.config/background"
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
TMP_FILE="/tmp/fzf_wallpaper_selection_$$"
KITTY_CLASS="kittymenu-switch-wallpaper"

KITTEN_ICAT='~/.local/kitty.app/bin/kitten icat \
  --clear \
  --transfer-mode=memory \
  --stdin=no \
  --place=${FZF_PREVIEW_COLUMNS}x${FZF_PREVIEW_LINES}@0x0 \
  {}'

FZF_BACKGROUND_PICKER="command ls | ~/.fzf/bin/fzf \
  --no-bold \
  --no-input \
  --layout=reverse \
  --header='Select background' \
  --color=bg+:0,fg+:12,hl+:3,border:12,gutter:-1,info:5,marker:12,pointer:1,prompt:12,header:3:bold \
  --preview-window='right,45%,border-left' \
  --preview='${KITTEN_ICAT}'"

select_background() {
  ~/.local/kitty.app/bin/kitty \
    --class "$KITTY_CLASS" \
    -T "$KITTY_CLASS" \
    -d "$WALLPAPER_DIR" \
    -o initial_window_width=970 \
    -o initial_window_height=240 \
    -o font_size=20 \
    bash -c "${FZF_BACKGROUND_PICKER} > ${TMP_FILE}"
}

apply_selected_background() {
  SELECTION=$(cat "${TMP_FILE}" 2>/dev/null)
  rm -f "${TMP_FILE}"
  [[ -z $SELECTION ]] && echo "no selection." && exit 1

  if [[ -f "$BACKGROUND_IMAGE" ]] && cmp -s "${WALLPAPER_DIR}/${SELECTION}" "$BACKGROUND_IMAGE"; then
    echo "selected wallpaper is already the current background."
    exit 0
  fi

  cp "${WALLPAPER_DIR}/${SELECTION}" "$BACKGROUND_IMAGE"
  niri msg action do-screen-transition
  pkill swaybg
  swaybg -i "$BACKGROUND_IMAGE" -m fill >/dev/null 2>&1 &
}

get_current_workspace() {
  niri msg -j workspaces | jq -r '.[] | select(.is_focused == true and .is_active == true)'
}

find_existing_window() {
  niri msg -j windows | jq --arg app_id "$KITTY_CLASS" -r '.[] | select(.app_id == $app_id)'
}

find_workspace_by_id() {
  niri msg -j workspaces | jq --arg id "$1" -r '.[] | select(.id == ($id|tonumber))'
}

handle_existing_app() {
  current_workspace=$(get_current_workspace)
  [[ -z "$current_workspace" ]] && return 1
  current_workspace_id=$(echo "$current_workspace" | jq -r '.id')
  current_workspace_idx=$(echo "$current_workspace" | jq -r '.idx')
  current_workspace_output=$(echo "$current_workspace" | jq -r '.output')

  existing_window=$(find_existing_window)
  [[ -z "$existing_window" ]] && return 1
  existing_window_id=$(echo "$existing_window" | jq -r '.id')
  existing_workspace_id=$(echo "$existing_window" | jq -r '.workspace_id')
  existing_workspace_output=$(echo $(find_workspace_by_id "$existing_workspace_id") | jq -r '.output')

  if [[ "$current_workspace_output" != "$existing_workspace_output" ]]; then
    niri msg action move-window-to-monitor \
      --id "$existing_window_id" \
      "$current_workspace_output"
  fi

  if [[ "$current_workspace_id" != "$existing_workspace_id" ]]; then
    niri msg action move-window-to-workspace \
      --focus true \
      --window-id "$existing_window_id" \
      "$current_workspace_idx"
  fi

  niri msg action focus-window --id "$existing_window_id"
  exit 0
}

main() {
  handle_existing_app
  select_background
  apply_selected_background
}

main
